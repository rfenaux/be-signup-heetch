jQuery(function(e){var t=window.socss;t.view.properties.controllers.font_select=t.view.propertyController.extend({template:_.template('<div class="font-wrapper"><select></select></div>'),initChangeEvents:function(){this.field.on("font_change",function(e,t,s){this.updateRule(t,s)}.bind(this))},render:function(){this.$el.append(e(this.template({}))),this.field=this.$el.find("select"),this.field.webfontselector({modules:this.args.modules})},setValue:function(e,t){t=_.extend({silent:!1},t),this.field.webfontselector("update",e),t.silent||this.trigger("set_value",e)},updateRule:function(e,t){var s=e.font?"'"+e.font+"'":"";s+=e.category?", "+e.category:"",this.propertiesView.setRuleValue(this.args.property,s);var i,r,a;if(e.webfont){i=this.args.modules[e.module],r=this.propertiesView.findImport(i.base_url);var n=e.font.replace(new RegExp("\\s","g"),"+");r?(a=this.importRuleToFontsInfo(r),-1===a.families.indexOf(n)&&a.families.push(n),"400"!==e.variant&&"regular"!==e.variant&&-1===a.variants.indexOf(e.variant)&&a.variants.push(e.variant),"latin"!==e.subset&&-1===a.subsets.indexOf(e.subset)&&a.subsets.push(e.subset),a.base_url=i.base_url,this.propertiesView.updateImport(i.base_url,this.fontsInfoToImportRule(a))):(a={base_url:i.base_url,families:[n]},"400"!==e.variant&&"regular"!==e.variant&&(a.variants=[e.variant]),"latin"!=e.subset&&(a.subsets=[e.subset]),this.propertiesView.addImport(this.fontsInfoToImportRule(a)))}if(t&&t.webfont){i=this.args.modules[t.module],r=this.propertiesView.findImport(i.base_url),a=this.importRuleToFontsInfo(r);for(var o=[],l=this.propertiesView.parsed.stylesheet.rules,u=0;u<l.length;u++){var p=l[u];if(p.declarations)for(var f=0;f<p.declarations.length;f++){var m=p.declarations[f];if("font-family"===m.property&&m.value){var h=m.value.match(/\'([^\']+)\'/)[1];-1==o.indexOf(h)&&o.push(h.replace(new RegExp("\\s","g"),"+"))}}}for(var d=[],v=0;v<a.families.length;v++){var h=a.families[v];-1==o.indexOf(h)&&d.push(h)}for(var b=0;b<d.length;b++)a.families.splice(a.families.indexOf(d[b]),1);a.base_url=i.base_url,a.families.length>0?this.propertiesView.updateImport(i.base_url,this.fontsInfoToImportRule(a)):this.propertiesView.removeImport(i.base_url)}},importRuleToFontsInfo:function(e){for(var t,s={families:[],variants:[],subsets:[]},i=/[\?|\&]([^=]+)\=([^&\s\)\;]+)/g;null!==(t=i.exec(e.import));)if("family"===t[1]){var r=t[2].split(":");s.families=r[0].split("|"),r.length>1&&(s.variants=r[1].split(","))}else"subset"===t[1]&&(s.subsets=t[2].split(","));return s},fontsInfoToImportRule:function(e){var t={type:"import"},s="url("+e.base_url+"?family="+e.families.join("|");return _.isEmpty(e.variants)||(s+=":"+e.variants.join(",")),_.isEmpty(e.subsets)||(s+="&subset="+e.subsets.join(",")),s+=")",t.import=s,t}}),window.socss.mainEditor.visualProperties.render()});